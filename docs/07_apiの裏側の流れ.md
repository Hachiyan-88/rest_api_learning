# APIの裏側の流れ（内部処理を図解する）

このページでは、
>クライアントがAPIを呼び出してから、レスポンスが返るまで

サーバー内部で何が起きているのかを整理する。

ここが見えるようになると、「何となく動いている」が終わり、
理解できるようになる。

---

## まず全体像

```JSON
①クライアントがリクエスト送信
        ↓
②Controllerが受け取る
        ↓
③JSON   →   オブジェクトへの変換
        ↓
④Serviceでビジネスロックを実行する
        ↓
⑤RepositoryでDB操作を行う
        ↓
⑥結果をオブジェクトにまとめる
        ↓
⑦オブジェクト   →   JSON変換
        ↓
⑧レスポンス返却
```

この流れを分解していく感じで整理していきます。

---

## ①クライアントがリクエスト送信

例：

```JSON
POST /users
Content-Type: application/json

{
    "name":"Taro",
    "age":25
}
```

この時点では、JSONはただのテキスト。

---

## ②Controllerが受け取る

Controllerは「受付係の人」。

- URLを見る
- HTTPメソッドを見る
- 対応する処理を呼び出す

例（Spring）：

```java
@PostMapping("/users")
public User create(@RequestBody User user) {
    return userService.save(user);
}
```

ここでJSONを受け取っている。

---

## ③JSON → オブジェクト変換（デシリアライズ）

※重要ポイント

- 送られてきたJSONは文字列
- フレームワークが自動でオブジェクトに変換する

これを
>**デシリアライズ**

という。

ここの型が一致していないと400エラーになる。

---

## ④Serviceでビジネスロックを実行する

Serviceは「頭脳」。

- 計算
- バリデーション
- 条件分岐
- 業務ルールの実行

Controllerにはロジックを書き過ぎないようにする。

役割分担が大事。

---

## ⑤RepositoryでDB操作

Repositoryは「データ担当」。

- DBから保存
- 保存
- 更新
- 削除

ここで初めてデータベースとのやり取りを行う感じ。

---

## ⑥結果をオブジェクトにまとめる

DBから取得したデータや処理結果を、レスポンス用オブジェクトにまとめる。

実務では：

- EntityとDTOを分けることが多い

理由：

- DB構造をそのまま外に出さないようにする
- セキュリティ
- API設計の柔軟性

---

## ⑦オブジェクト → JSON変換（シリアライズ）

レスポンスを返す時、
>オブジェクトをJSON文字列に変換する

これを
>シリアライズ

という。

---

## ⑧レスポンス返却

最終的に：

```JSON
{
    "id":1,
    "name":"Taro",
    "age":25
}
```

がクライアントに返るようになっている。

---

## よくあるつまずきポイント

- フィールド名がJSONと一致していない
- getter / setterがない
- 型が違う
- nullの扱いでエラー

結構、初心者あるあるだから気にするようにする。

---

## 3層構造で整理（確認用）

```JSON
Controller  →   受付
Service     →   頭脳
Repository  →   データ担当
```

それぞれに違う役割がある。

全部をControllerに記述することはNG！

---

### 自分用メモ

- JSONはそのままでは使えない
- デシリアライズでオブジェクト化
- シリアライズでJSON化
- 役割分担が設計の基本になっている

---

## まとめ

APIの裏側では：

- JSON変換
- ビジネスロック
- DB操作

が順番に行われる。

この流れをイメージできるようになると、
エラーが起きたときに「どこで止まっているか」を考えられるようになるらしい。

---

👈 前へ → :[06_RESTとJSONの関係](06_restとjsonの関係.html)

👉 次へ → :[08_よくある勘違い集](08_よくある勘違い.html)

---

👈 TOPへ → :[TOPページ](index.html)
